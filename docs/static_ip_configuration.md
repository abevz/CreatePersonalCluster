# Настройка статических IP адресов для кластера

Данная документация описывает как настроить статические IP адреса для узлов Kubernetes кластера в проекте CPC с учетом разных рабочих пространств (workspaces).

## Зачем нужны статические IP адреса

Статические IP адреса необходимы для обеспечения стабильной работы Kubernetes кластера. Без статических IP адресов:

1. При перезапуске виртуальных машин они могут получить новые IP адреса через DHCP
2. Это приводит к сбоям в работе кластера, так как узлы теряют связь друг с другом
3. Требуется повторная настройка или восстановление кластера

## Автоматическое распределение IP по рабочим пространствам

CPC использует умную систему распределения IP-адресов, которая:

1. Автоматически выделяет блоки IP-адресов для каждого workspace (ubuntu, debian, k8s133 и т.д.)
2. Учитывает роль узла (control plane или worker) при назначении адресов
3. Предотвращает конфликты с существующими статическими устройствами в вашей сети
4. **Автоматически управляет индексами workspace** при создании или удалении рабочих пространств

## Настройка глобальных параметров сети

Глобальные сетевые настройки задаются в файле `cpc.env` и применяются ко всем рабочим пространствам:

```bash
# Network addressing and IP allocation
NETWORK_CIDR="10.10.10.0/24"            # Base network CIDR
NETWORK_GATEWAY="10.10.10.1"            # Network gateway (router)
STATIC_IP_START="110"                   # Starting IP for clusters (e.g., 110 for 10.10.10.110)
WORKSPACE_IP_BLOCK_SIZE="10"            # Number of IPs per workspace/cluster

# DNS settings
PRIMARY_DNS_SERVER="10.10.10.100"       # Primary DNS server (e.g. Pi-hole)
SECONDARY_DNS_SERVER="8.8.8.8"          # Secondary DNS server
```

Эти глобальные настройки автоматически экспортируются как переменные Terraform при выполнении любой команды `cpc`.

## Переопределение настроек для конкретного workspace

При необходимости вы можете переопределить глобальные настройки для конкретного workspace в его файле окружения:

```bash
# Переопределение глобальных сетевых настроек
export TF_VAR_network_cidr="192.168.1.0/24"     # Другая подсеть для этого workspace
export TF_VAR_network_gateway="192.168.1.1"     # Другой шлюз
export TF_VAR_ip_range_start=200                # Начинать с IP .200
export TF_VAR_dns_servers='["192.168.1.10"]'    # Свой DNS-сервер
```

## Схема распределения IP-адресов

Система автоматически назначает IP-адреса по следующей формуле:

```
IP = базовый_IP + (индекс_workspace * размер_блока) + смещение_узла
```

Где:
- `базовый_IP` - значение переменной `STATIC_IP_START` из `cpc.env` (по умолчанию 110)
- `индекс_workspace` - позиция текущего workspace в карте (`ubuntu`=1, `debian`=2, ...)
- `размер_блока` - значение переменной `WORKSPACE_IP_BLOCK_SIZE` (по умолчанию 10)
- `смещение_узла` - зависит от роли и индекса узла (control plane: 0-4, worker: 5-9)

### Примеры распределения IP (при ip_range_start=110, block_size=10)

1. **Ubuntu workspace (индекс 1)**:
   - Control Plane 1: `10.10.10.110`
   - Worker 1: `10.10.10.115`
   - Worker 2: `10.10.10.116`

2. **Debian workspace (индекс 2)**:
   - Control Plane 1: `10.10.10.120`
   - Worker 1: `10.10.10.125`
   - Worker 2: `10.10.10.126`

3. **k8s129-test workspace (индекс 3)**:
   - Control Plane 1: `10.10.10.130`
   - Worker 1: `10.10.10.135`
   - и т.д.

## Автоматическое управление индексами workspace

При создании и удалении workspace через команды `cpc clone-workspace` и `cpc delete-workspace` система автоматически:

1. **При клонировании workspace**:
   - Находит следующий свободный индекс в карте `workspace_ip_map`
   - Добавляет новый workspace с этим индексом
   - Вычисляет и выводит диапазон IP адресов для нового workspace

2. **При удалении workspace**:
   - Удаляет запись из карты `workspace_ip_map`
   - Освобождает индекс для повторного использования
   - Индексы других workspace остаются неизменными

**Важно**: Индексы workspace не перенумеровываются при удалении workspace из середины списка, чтобы сохранить стабильность IP-адресов для существующих кластеров.

## Учет существующих устройств

Система спроектирована так, чтобы избегать конфликтов с существующими устройствами в вашей сети:

1. Задайте значение `STATIC_IP_START` в `cpc.env` так, чтобы выделяемые диапазоны не пересекались с:
   - Диапазоном DHCP (обычно 10.10.10.2 - 10.10.10.99)
   - Существующими устройствами со статическим IP (например, DNS, Proxmox и другие)

2. Рекомендуемая стратегия:
   - DHCP диапазон: 10.10.10.2 - 10.10.10.99
   - Инфраструктурные устройства: 10.10.10.100 - 10.10.10.109 
   - Kubernetes кластеры: начиная с 10.10.10.110

## Пример использования

1. **Создание нового workspace с автоматическим выделением IP диапазона**:
   ```bash
   ./cpc clone-workspace ubuntu my-cluster m
   ```

2. **Проверка выделенного диапазона**:
   ```bash
   grep "my-cluster" ./terraform/variables.tf
   # Вывод примера: "my-cluster" = 7 // IP-блок #7: 10.10.10.170-179
   ```

3. **Удаление workspace**:
   ```bash
   ./cpc delete-workspace my-cluster
   ```

## Предостережения и рекомендации

1. Не редактируйте карту `workspace_ip_map` вручную - используйте команды `cpc clone-workspace` и `cpc delete-workspace`
2. Убедитесь, что выбранные IP адреса не конфликтуют с другими устройствами в вашей сети
3. Если в сети используется DHCP, настройте исключения для статических IP диапазонов
4. При изменении IP адресов существующих узлов кластера может потребоваться повторная настройка кластера
